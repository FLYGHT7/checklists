{% extends 'base.html' %}
{% load static %}

{% block title %}{{ dynamic_form.title }} - Vista Previa - DragTask{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/dynamic_forms.css' %}">
{% endblock %}

{% block content %}
<section class="form-view-section py-5">
<div class="container">
  <div class="row mb-4">
    <div class="col-lg-8">
      <h1 class="fw-bold">{{ dynamic_form.title }}</h1>
      {% if dynamic_form.description %}
        <p class="lead">{{ dynamic_form.description }}</p>
      {% endif %}
    </div>
    <div class="col-lg-4 text-lg-end">
      <div class="d-flex flex-column flex-sm-row gap-2 justify-content-lg-end">
        {% if dynamic_form.user == request.user %}
          <a href="{% url 'view_form' dynamic_form.id %}" class="btn btn-primary">
            <i class="bi bi-pencil-square me-2"></i>Editar Formulario
          </a>
          <a href="{% url 'view_form_responses' dynamic_form.id %}" class="btn btn-outline-primary">
            <i class="bi bi-bar-chart me-2"></i>Ver Respuestas
          </a>
        {% endif %}
        <a href="{% url 'dynamic_forms' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Volver
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="form-preview-card">
        {% if not dynamic_form.is_published and dynamic_form.user != request.user %}
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>Este formulario no está publicado y solo es visible para ti como propietario.
          </div>
        {% endif %}
        
        <form method="post" action="{% url 'submit_form_response' dynamic_form.id %}" enctype="multipart/form-data">
          {% csrf_token %}
          
          {% for question in questions %}
            <div class="question-preview-item">
              <div class="question-text">
                <h5>
                  {{ question.text }}
                  {% if question.is_required %}
                    <span class="text-danger">*</span>
                  {% endif %}
                </h5>
                {% if question.help_text %}
                  <p class="text-muted small">{{ question.help_text }}</p>
                {% endif %}
              </div>
              
              <div class="question-answer mt-3">
                {% if question.question_type == 'short_text' %}
                  <input type="text" name="question_{{ question.id }}" class="form-control" {% if question.is_required %}required{% endif %}>
                
                {% elif question.question_type == 'paragraph' %}
                  <textarea name="question_{{ question.id }}" class="form-control" rows="3" {% if question.is_required %}required{% endif %}></textarea>
                
                {% elif question.question_type == 'multiple_choice' %}
                  <div class="form-options">
                    {% for option in question.options.all %}
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="option_{{ option.id }}" value="{{ option.id }}" {% if question.is_required %}required{% endif %}>
                        <label class="form-check-label" for="option_{{ option.id }}">
                          {{ option.text }}
                        </label>
                      </div>
                    {% empty %}
                      <p class="text-muted">No hay opciones disponibles</p>
                    {% endfor %}
                  </div>
                
                {% elif question.question_type == 'checkbox' %}
                  <div class="form-options">
                    {% for option in question.options.all %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="question_{{ question.id }}" id="option_{{ option.id }}" value="{{ option.id }}">
                        <label class="form-check-label" for="option_{{ option.id }}">
                          {{ option.text }}
                        </label>
                      </div>
                    {% empty %}
                      <p class="text-muted">No hay opciones disponibles</p>
                    {% endfor %}
                  </div>
                
                {% elif question.question_type == 'dropdown' %}
                  <select name="question_{{ question.id }}" class="form-select" {% if question.is_required %}required{% endif %}>
                    <option value="" selected disabled>Selecciona una opción</option>
                    {% for option in question.options.all %}
                      <option value="{{ option.id }}">{{ option.text }}</option>
                    {% endfor %}
                  </select>
                
                {% elif question.question_type == 'file_upload' %}
                  <input type="file" name="question_{{ question.id }}" class="form-control" {% if question.is_required %}required{% endif %}>
                
                {% elif question.question_type == 'linear_scale' %}
                  <div class="linear-scale-preview">
                    <div class="scale-labels d-flex justify-content-between mb-2">
                      <span>{{ question.min_label|default:question.min_value|default:"1" }}</span>
                      <span>{{ question.max_label|default:question.max_value|default:"5" }}</span>
                    </div>
                    <div class="scale-options d-flex justify-content-between">
                      {% with min_value=question.min_value|default:1 max_value=question.max_value|default:5 %}
                        {% for i in "12345678910"|make_list %}
                          {% if forloop.counter <= max_value and forloop.counter >= min_value %}
                            <div class="form-check">
                              <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="scale_{{ question.id }}_{{ forloop.counter }}" value="{{ forloop.counter }}" {% if question.is_required %}required{% endif %}>
                              <label class="form-check-label" for="scale_{{ question.id }}_{{ forloop.counter }}">
                                {{ forloop.counter }}
                              </label>
                            </div>
                          {% endif %}
                        {% endfor %}
                      {% endwith %}
                    </div>
                  </div>
                
                {% elif question.question_type == 'date' %}
                  <input type="date" name="question_{{ question.id }}" class="form-control" {% if question.is_required %}required{% endif %}>
                
                {% elif question.question_type == 'time' %}
                  <input type="time" name="question_{{ question.id }}" class="form-control" {% if question.is_required %}required{% endif %}>
                
                {% elif question.question_type == 'datetime' %}
                  <input type="datetime-local" name="question_{{ question.id }}" class="form-control" {% if question.is_required %}required{% endif %}>
                
                {% elif question.question_type == 'multiple_choice_grid' or question.question_type == 'checkbox_grid' %}
                  <div class="grid-preview">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          {% for column in question.columns_text.splitlines %}
                            {% if column %}
                              <th>{{ column }}</th>
                            {% endif %}
                          {% empty %}
                            <th>Columna 1</th>
                            <th>Columna 2</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in question.rows_text.splitlines %}
                          {% if row %}
                            <tr>
                              <td>{{ row }}</td>
                              {% for column in question.columns_text.splitlines %}
                                {% if column %}
                                  <td>
                                    {% if question.question_type == 'multiple_choice_grid' %}
                                      <input type="radio" class="form-check-input" name="question_{{ question.id }}_row_{{ forloop.parentloop.counter }}" value="{{ forloop.counter }}" {% if question.is_required %}required{% endif %}>
                                    {% else %}
                                      <input type="checkbox" class="form-check-input" name="question_{{ question.id }}_row_{{ forloop.parentloop.counter }}_col_{{ forloop.counter }}" value="1">
                                    {% endif %}
                                  </td>
                                {% endif %}
                              {% empty %}
                                <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_{{ forloop.counter }}" value="1" {% if question.is_required %}required{% endif %}></td>
                                <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_{{ forloop.counter }}" value="2" {% if question.is_required %}required{% endif %}></td>
                              {% endfor %}
                            </tr>
                          {% endif %}
                        {% empty %}
                          <tr>
                            <td>Fila 1</td>
                            <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_1" value="1" {% if question.is_required %}required{% endif %}></td>
                            <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_1" value="2" {% if question.is_required %}required{% endif %}></td>
                          </tr>
                          <tr>
                            <td>Fila 2</td>
                            <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_2" value="1" {% if question.is_required %}required{% endif %}></td>
                            <td><input type="radio" class="form-check-input" name="question_{{ question.id }}_row_2" value="2" {% if question.is_required %}required{% endif %}></td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="empty-state">
              <i class="bi bi-question-circle"></i>
              <h3>No hay preguntas en este formulario</h3>
              <p>El creador aún no ha añadido preguntas a este formulario.</p>
            </div>
          {% endfor %}
          
          {% if questions %}
            <div class="d-grid mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-send me-2"></i>Enviar Respuesta
              </button>
            </div>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
</section>

<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Código para mostrar toasts si es necesario
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} show`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    
    toast.innerHTML = `
      <div class="toast-body">
        ${message}
      </div>
    `;
    
    const toastContainer = document.getElementById('toastContainer');
    toastContainer.appendChild(toast);
    
    // Eliminar después de 3 segundos
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        toastContainer.removeChild(toast);
      }, 300);
    }, 3000);
  }

  // Mostrar toast si hay un mensaje en la URL
  const urlParams = new URLSearchParams(window.location.search);
  const message = urlParams.get('message');
  const messageType = urlParams.get('type') || 'info';

  if (message) {
    showToast(message, messageType);
  }
});
</script>
{% endblock %}