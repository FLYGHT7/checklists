{% extends 'base.html' %}
{% load static %}
{% load custom_i18n %}

{% block title %}{% trans_tag "Question Bank" %} - DragTask{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/forms_google.css' %}?v={% now 'U' %}">
<style>
  /* Estilos para el banco de preguntas con diseño coherente */
  /* Header con gradiente */
  .bank-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    padding: 1.5rem 0;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  [data-bs-theme="dark"] .bank-header {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  
  .bank-header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 0 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='rgba(255,255,255,0.1)' fill-rule='evenodd'/%3E%3C/svg%3E");
    opacity: 0.5;
    z-index: 0;
  }
  
  .bank-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    animation: fadeInDown 0.6s ease-out;
    background: linear-gradient(to right, #ffffff, rgba(255, 255, 255, 0.8));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
    display: inline-block;
    border-bottom: 3px solid rgba(255, 255, 255, 0.3);
    padding-bottom: 0.5rem;
  }
  
  .bank-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.2rem;
    position: relative;
    z-index: 1;
    max-width: 700px;
    line-height: 1.7;
    animation: fadeInUp 0.6s ease-out;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  .bank-container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }

  .bank-header-content {
    position: relative;
    z-index: 2;
  }
  
  .bank-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.35rem 0.75rem;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 1rem;
    backdrop-filter: blur(4px);
    animation: fadeInLeft 0.6s ease-out;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .bank-badge i {
    margin-right: 0.5rem;
    font-size: 1rem;
  }
  
  /* Botones de acción */
  .action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .back-button {
    color: var(--neutral-600);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 1px solid var(--neutral-300);
    border-radius: 8px;
    background-color: white;
    transition: all 0.2s ease;
    font-weight: 500;
  }
  
  [data-bs-theme="dark"] .back-button {
    background-color: var(--neutral-800);
    border-color: var(--neutral-700);
    color: var(--neutral-300);
  }
  
  .back-button:hover {
    background-color: var(--neutral-100);
    color: var(--primary);
    border-color: var(--primary-light);
  }
  
  [data-bs-theme="dark"] .back-button:hover {
    background-color: var(--neutral-750);
    color: var(--primary-light);
  }
  
  .clean-button {
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
    background-color: rgba(239, 68, 68, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
  }
  
  .clean-button i {
    margin-right: 0.5rem;
  }
  
  .clean-button:hover {
    background-color: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
  }
  
  /* Barra de búsqueda */
  .search-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    background-color: white;
    padding: 0.75rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--neutral-200);
  }
  
  [data-bs-theme="dark"] .search-bar {
    background-color: var(--neutral-800);
    border-color: var(--neutral-700);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .search-input {
    flex-grow: 1;
    position: relative;
  }
  
  .search-input i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--neutral-500);
  }
  
  .search-input input {
    width: 100%;
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    border: 1px solid var(--neutral-300);
    border-radius: 8px;
    background-color: white;
    color: var(--neutral-800);
  }
  
  [data-bs-theme="dark"] .search-input input {
    background-color: var(--neutral-750);
    border-color: var(--neutral-600);
    color: var(--neutral-200);
  }
  
  .search-input input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.3);
    border-color: var(--primary);
  }
  
  .filter-select, .sort-select {
    padding: 0.5rem 2rem 0.5rem 1rem;
    border: 1px solid var(--neutral-300);
    border-radius: 8px;
    background-color: white;
    color: var(--neutral-800);
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
  }
  
  [data-bs-theme="dark"] .filter-select, 
  [data-bs-theme="dark"] .sort-select {
    background-color: var(--neutral-750);
    border-color: var(--neutral-600);
    color: var(--neutral-200);
  }
  
  .filter-select:focus, .sort-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.3);
    border-color: var(--primary);
  }
  
  /* Lista de preguntas - Diseño de tarjetas compactas */
  .question-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
  }
  
  .question-item {
    background-color: white;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--neutral-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    animation: fadeIn 0.5s ease-out forwards;
    display: flex;
    flex-direction: column;
  }
  
  [data-bs-theme="dark"] .question-item {
    background-color: var(--neutral-800);
    border-color: var(--neutral-700);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .question-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  [data-bs-theme="dark"] .question-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .question-header {
    padding: 0.75rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    position: relative;
  }
  
  .question-type {
    display: inline-block;
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    margin-bottom: 0.25rem;
  }
  
  .question-date {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.8);
  }
  
  .question-text {
    font-size: 0.95rem;
    font-weight: 500;
    margin-top: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.3;
    max-height: 2.6rem;
  }
  
  .question-body {
    padding: 0.75rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .question-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-top: 1px solid var(--neutral-200);
    margin-top: auto;
  }
  
  [data-bs-theme="dark"] .question-footer {
    border-top-color: var(--neutral-700);
  }
  
  .question-usage {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--neutral-600);
  }
  
  [data-bs-theme="dark"] .question-usage {
    color: var(--neutral-400);
  }
  
  .question-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .bank-action-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: transparent;
    color: var(--neutral-600);
    border: none;
    transition: all 0.2s ease;
    cursor: pointer;
    font-size: 0.85rem;
  }
  
  [data-bs-theme="dark"] .bank-action-btn {
    color: var(--neutral-400);
  }
  
  .bank-action-btn:hover {
    background-color: var(--neutral-100);
    color: var(--primary);
  }
  
  [data-bs-theme="dark"] .bank-action-btn:hover {
    background-color: var(--neutral-750);
    color: var(--primary-light);
  }
  
  .edit-btn:hover {
    color: #6366f1;
    background-color: rgba(99, 102, 241, 0.1);
  }
  
  .delete-btn:hover {
    color: #ef4444;
    background-color: rgba(239, 68, 68, 0.1);
  }
  
  /* Estado vacío */
  .empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    background-color: white;
    border-radius: 12px;
    border: 1px solid var(--neutral-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.5s ease-out;
    grid-column: 1 / -1;
  }
  
  [data-bs-theme="dark"] .empty-state {
    background-color: var(--neutral-800);
    border-color: var(--neutral-700);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  .empty-state i {
    font-size: 3rem;
    color: var(--neutral-400);
    margin-bottom: 1rem;
    opacity: 0.7;
  }
  
  .empty-state h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--neutral-700);
  }
  
  [data-bs-theme="dark"] .empty-state h3 {
    color: var(--neutral-300);
  }
  
  .empty-state p {
    color: var(--neutral-500);
    font-size: 1rem;
    max-width: 400px;
    margin: 0 auto;
  }
  
  [data-bs-theme="dark"] .empty-state p {
    color: var(--neutral-400);
  }
  
  /* Modal styles */
  .modal-content {
    background-color: white;
    color: var(--neutral-800);
    border: none;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  
  [data-bs-theme="dark"] .modal-content {
    background-color: var(--neutral-800);
    color: var(--neutral-200);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  }
  
  .modal-header {
    border-bottom: 1px solid var(--neutral-200);
    padding: 1rem 1.5rem;
  }
  
  [data-bs-theme="dark"] .modal-header {
    border-bottom-color: var(--neutral-700);
  }
  
  .modal-footer {
    border-top: 1px solid var(--neutral-200);
    padding: 1rem 1.5rem;
  }
  
  [data-bs-theme="dark"] .modal-footer {
    border-top-color: var(--neutral-700);
  }
  
  .btn-close {
    opacity: 0.7;
  }
  
  [data-bs-theme="dark"] .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }
  
  .form-control, .form-select {
    background-color: white;
    border: 1px solid var(--neutral-300);
    color: var(--neutral-800);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
  
  [data-bs-theme="dark"] .form-control, 
  [data-bs-theme="dark"] .form-select {
    background-color: var(--neutral-750);
    border-color: var(--neutral-600);
    color: var(--neutral-200);
  }
  
  .form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.25);
  }
  
  .form-check-input {
    background-color: white;
    border: 1px solid var(--neutral-400);
  }
  
  [data-bs-theme="dark"] .form-check-input {
    background-color: var(--neutral-750);
    border-color: var(--neutral-500);
  }
  
  .form-check-input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
  }
  
  .form-label {
    font-weight: 500;
    margin-bottom: 0.25rem;
    color: var(--neutral-700);
  }
  
  [data-bs-theme="dark"] .form-label {
    color: var(--neutral-300);
  }
  
  .form-text {
    color: var(--neutral-500);
    font-size: 0.8rem;
  }
  
  [data-bs-theme="dark"] .form-text {
    color: var(--neutral-400);
  }
  
  /* Toast styles */
  .toast {
    background-color: white;
    color: var(--neutral-800);
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }
  
  [data-bs-theme="dark"] .toast {
    background-color: var(--neutral-800);
    color: var(--neutral-200);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .toast-header {
    background-color: var(--neutral-100);
    color: var(--neutral-800);
    border-bottom: 1px solid var(--neutral-200);
  }
  
  [data-bs-theme="dark"] .toast-header {
    background-color: var(--neutral-750);
    color: var(--neutral-200);
    border-bottom-color: var(--neutral-700);
  }
  
  /* Animaciones */
  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes fadeInLeft {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Responsive */
  @media (max-width: 767px) {
    .bank-title {
      font-size: 2rem;
    }
    
    .bank-subtitle {
      font-size: 1rem;
    }
    
    .search-bar {
      flex-direction: column;
    }
    
    .question-list {
      grid-template-columns: 1fr;
    }
    
    .action-bar {
      flex-direction: column;
      gap: 0.75rem;
      align-items: stretch;
    }
  }

/* Mejorar el contraste en modo oscuro para los botones y elementos interactivos */
[data-bs-theme="dark"] .bank-action-btn {
  color: var(--neutral-300);
  background-color: rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .bank-action-btn:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: white;
}

[data-bs-theme="dark"] .edit-btn:hover {
  color: #818cf8;
  background-color: rgba(129, 140, 248, 0.2);
}

[data-bs-theme="dark"] .delete-btn:hover {
  color: #f87171;
  background-color: rgba(248, 113, 113, 0.2);
}

/* Mejorar el contraste de los menús desplegables en modo oscuro */
[data-bs-theme="dark"] .filter-select, 
[data-bs-theme="dark"] .sort-select {
  background-color: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23e2e8f0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
}

/* Mejorar el contraste del botón de limpieza en modo oscuro */
[data-bs-theme="dark"] .clean-button {
  color: #f87171;
  border-color: rgba(248, 113, 113, 0.4);
  background-color: rgba(248, 113, 113, 0.15);
}

[data-bs-theme="dark"] .clean-button:hover {
  background-color: rgba(248, 113, 113, 0.25);
  border-color: rgba(248, 113, 113, 0.6);
}

/* Mejorar el contraste del botón de volver en modo oscuro */
[data-bs-theme="dark"] .back-button {
  background-color: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
}

[data-bs-theme="dark"] .back-button:hover {
  background-color: #334155;
  color: white;
  border-color: #64748b;
}

/* Mejorar el contraste de la barra de búsqueda en modo oscuro */
[data-bs-theme="dark"] .search-input input {
  background-color: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
}

[data-bs-theme="dark"] .search-input i {
  color: #94a3b8;
}

/* Mejorar el contraste de las tarjetas en modo oscuro */
[data-bs-theme="dark"] .question-item {
  background-color: #1e293b;
  border-color: #334155;
}

[data-bs-theme="dark"] .question-footer {
  border-top-color: #334155;
}

/* Mejorar el contraste de los modales en modo oscuro */
[data-bs-theme="dark"] .modal-content {
  background-color: #0f172a;
  color: #e2e8f0;
}

[data-bs-theme="dark"] .modal-header,
[data-bs-theme="dark"] .modal-footer {
  border-color: #334155;
}

/* Mejorar el contraste de los formularios en modo oscuro */
[data-bs-theme="dark"] .form-control,
[data-bs-theme="dark"] .form-select {
  background-color: #1e293b;
  border-color: #475569;
  color: #e2e8f0;
}

[data-bs-theme="dark"] .form-label {
  color: #e2e8f0;
}

[data-bs-theme="dark"] .form-check-input {
  background-color: #1e293b;
  border-color: #475569;
}
</style>
{% endblock %}

{% block content %}
<!-- Header con gradiente -->
<div class="bank-header">
  <div class="container">
    <div class="bank-container">
      <div class="bank-header-content">
        <div class="bank-badge">
          <i class="bi bi-archive"></i>{% trans_tag "Question Bank" %}
        </div>
        <h1 class="bank-title">{% trans_tag "My Question Bank" %}</h1>
        <p class="bank-subtitle">
          {% trans_tag "Manage your saved questions and reuse them in your forms" %}
        </p>
      </div>
    </div>
  </div>
</div>

<div class="container mb-5">
  <div class="bank-container">
    <!-- Barra de acciones -->
    <div class="action-bar">
      <a href="{% url 'gform_list' %}" class="back-button">
        <i class="bi bi-arrow-left me-2"></i> {% trans_tag "Back to forms" %}
      </a>
      <button type="button" class="clean-button clean-duplicates-btn">
        <i class="bi bi-trash"></i> {% trans_tag "Clean duplicates" %}
      </button>
    </div>
    
    <!-- Barra de búsqueda -->
    <div class="search-bar">
      <div class="search-input">
        <i class="bi bi-search"></i>
        <input type="text" id="searchInput" placeholder="{% trans_tag 'Search questions' %}">
      </div>
      <select class="filter-select" id="typeFilter">
        <option value="">{% trans_tag "Filter by type" %}</option>
        <option value="short_text">{% trans_tag "Short Text" %}</option>
        <option value="paragraph">{% trans_tag "Paragraph" %}</option>
        <option value="multiple_choice">{% trans_tag "Multiple Choice" %}</option>
        <option value="checkbox">{% trans_tag "Checkboxes" %}</option>
        <option value="dropdown">{% trans_tag "Dropdown" %}</option>
        <option value="linear_scale">{% trans_tag "Linear Scale" %}</option>
        <option value="date">{% trans_tag "Date" %}</option>
        <option value="time">{% trans_tag "Time" %}</option>
      </select>
      <select class="sort-select" id="sortFilter">
        <option value="recent">{% trans_tag "Most recent" %}</option>
        <option value="usage">{% trans_tag "Most used" %}</option>
        <option value="alpha">{% trans_tag "Alphabetical" %}</option>
      </select>
    </div>
    
    <!-- Lista de preguntas -->
    <div id="questionBank" class="question-list">
      {% if bank_questions %}
        {% for question in bank_questions %}
          <div class="question-item" data-id="{{ question.id }}" data-type="{{ question.question_type }}" data-text="{{ question.text|slugify }}" data-hash="{{ question.hash|default:'' }}">
            <div class="question-header">
              <div class="question-type">{{ question.get_question_type_display }}</div>
              <div class="question-date">{{ question.created_at|date:"d/m/Y" }}</div>
              <div class="question-text">{{ question.text }}</div>
            </div>
            <div class="question-body">
              {% if question.help_text %}
                <p class="question-help text-muted small mb-2">{{ question.help_text|truncatechars:60 }}</p>
              {% endif %}
            </div>
            <div class="question-footer">
              <div class="question-usage">
                <i class="bi bi-bar-chart"></i> {{ question.usage_count }} {% trans_tag "forms" %}
              </div>
              <div class="question-actions">
                <button type="button" class="bank-action-btn edit-btn edit-bank-question-btn" data-id="{{ question.id }}" title="{% trans_tag 'Edit question' %}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="bank-action-btn delete-btn delete-bank-question-btn" data-id="{{ question.id }}" title="{% trans_tag 'Delete question' %}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-archive"></i>
          <h3>{% trans_tag "No questions found" %}</h3>
          <p>{% trans_tag "Save questions to the bank to reuse them in other forms." %}</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">{% trans_tag "Delete question" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmText">{% trans_tag "Are you sure you want to delete this question?" %}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans_tag "Cancel" %}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">{% trans_tag "Delete" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar preguntas (versión compacta) -->
<div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editQuestionModalLabel">{% trans_tag "Edit Question" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editQuestionForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          
          <div class="mb-3">
            <label for="edit_question_type" class="form-label">{% trans_tag "Question type" %}</label>
            <select name="question_type" id="edit_question_type" class="form-select" required>
              <option value="short_text">{% trans_tag "Short Text" %}</option>
              <option value="paragraph">{% trans_tag "Paragraph" %}</option>
              <option value="multiple_choice">{% trans_tag "Multiple Choice" %}</option>
              <option value="checkbox">{% trans_tag "Checkboxes" %}</option>
              <option value="dropdown">{% trans_tag "Dropdown" %}</option>
              <option value="linear_scale">{% trans_tag "Linear Scale" %}</option>
              <option value="date">{% trans_tag "Date" %}</option>
              <option value="time">{% trans_tag "Time" %}</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="edit_text" class="form-label">{% trans_tag "Question text" %}</label>
            <input type="text" name="text" id="edit_text" class="form-control" required>
          </div>
          
          <div class="mb-3">
            <label for="edit_help_text" class="form-label">{% trans_tag "Help text" %} <small class="text-muted">({% trans_tag "optional" %})</small></label>
            <input type="text" name="help_text" id="edit_help_text" class="form-control">
          </div>
          
          <div class="row">
            <div class="col-6">
              <div class="form-check mb-3">
                <input type="checkbox" name="is_required" id="edit_is_required" class="form-check-input">
                <label for="edit_is_required" class="form-check-label">{% trans_tag "Required" %}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check mb-3">
                <input type="checkbox" name="allow_attachments" id="edit_allow_attachments" class="form-check-input">
                <label for="edit_allow_attachments" class="form-check-label">{% trans_tag "Allow attachments" %}</label>
              </div>
            </div>
          </div>
          
          <!-- Campos específicos para escala lineal (versión compacta) -->
          <div id="editLinearScaleFields" class="d-none">
            <hr class="my-2">
            <div class="row g-2">
              <div class="col-6">
                <label for="edit_min_value" class="form-label">{% trans_tag "Min value" %}</label>
                <input type="number" name="min_value" id="edit_min_value" class="form-control" value="1" min="0" max="10">
              </div>
              <div class="col-6">
                <label for="edit_max_value" class="form-label">{% trans_tag "Max value" %}</label>
                <input type="number" name="max_value" id="edit_max_value" class="form-control" value="5" min="1" max="10">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans_tag "Cancel" %}</button>
        <button type="button" class="btn btn-primary" id="updateQuestionBtn">{% trans_tag "Save" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast para notificaciones -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-info-circle me-2"></i>
      <strong class="me-auto">{% trans_tag "Notification" %}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage">
      {% trans_tag "Notification message" %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Definir variables globales
  window.bootstrap = window.bootstrap || {}

  // Función para obtener el valor de una cookie (para CSRF)
  function getCookie(name) {
    let cookieValue = null
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";")
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim()
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
          break
        }
      }
    }
    return cookieValue
  }

  // Función para mostrar notificaciones
  function showToast(message, type = "info") {
    // Verificar si existe un contenedor de toast
    const toastMessage = document.getElementById("toastMessage")
    if (toastMessage) {
      toastMessage.textContent = message
      
      const toast = new bootstrap.Toast(document.getElementById("notificationToast"))
      toast.show()
    } else {
      // Fallback si no existe el toast en el DOM
      console.log(`${type.toUpperCase()}: ${message}`)
      alert(message)
    }
  }

  // Función para eliminar una pregunta del banco
  function deleteBankQuestion(questionId) {
    // Crear un token CSRF
    const csrftoken = getCookie("csrftoken")

    // Enviar la solicitud para eliminar la pregunta directamente
    fetch(`/forms/question-bank/${questionId}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        // Limpiar cualquier backdrop modal que pueda haber quedado
        removeModalBackdrop()

        if (data.success) {
          // Eliminar el elemento del DOM sin recargar la página
          const questionElement = document.querySelector(`.question-item[data-id="${questionId}"]`)
          if (questionElement) {
            // Animación de desvanecimiento antes de eliminar
            questionElement.style.transition = "opacity 0.3s ease"
            questionElement.style.opacity = "0"

            setTimeout(() => {
              questionElement.remove()

              // Si no quedan preguntas, mostrar mensaje
              const bankContainer = document.getElementById("questionBank")
              if (bankContainer && !bankContainer.querySelector(".question-item")) {
                bankContainer.innerHTML = `
                <div class="empty-state">
                  <i class="bi bi-archive"></i>
                  <h3>{% trans_tag "No questions found" %}</h3>
                  <p>{% trans_tag "Save questions to the bank to reuse them in other forms." %}</p>
                </div>
              `
              }
            }, 300)
          }

          // Mostrar notificación
          showToast(data.message || "{% trans_tag 'Question successfully deleted' %}", "success")
        } else {
          showToast(
            "{% trans_tag 'Error' %}: " + (data.error || "{% trans_tag 'Could not delete the question' %}"),
            "danger"
          )
        }
      })
      .catch((error) => {
        console.error("Error:", error)
        showToast("{% trans_tag 'Error deleting the question' %}", "danger")

        // Limpiar cualquier backdrop modal que pueda haber quedado
        removeModalBackdrop()
      })
  }

  // Función para editar una pregunta del banco
  function editBankQuestion(questionId) {
    // Obtener los datos de la pregunta
    fetch(`/forms/question-bank/${questionId}/`, {
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`)
        }
        return response.json()
      })
      .then((data) => {
        if (data.success) {
          const question = data.question

          // Llenar el formulario de edición
          const editModal = document.getElementById("editQuestionModal")
          if (editModal) {
            const form = editModal.querySelector("form")
            form.action = `/forms/question-bank/${questionId}/edit/`

            // Llenar los campos del formulario
            const textField = form.querySelector("#edit_text")
            if (textField) textField.value = question.text

            const helpTextField = form.querySelector("#edit_help_text")
            if (helpTextField) helpTextField.value = question.help_text || ""

            const isRequiredField = form.querySelector("#edit_is_required")
            if (isRequiredField) isRequiredField.checked = question.is_required

            const allowAttachmentsField = form.querySelector("#edit_allow_attachments")
            if (allowAttachmentsField) allowAttachmentsField.checked = question.allow_attachments

            // Seleccionar el tipo de pregunta
            const typeSelect = form.querySelector("#edit_question_type")
            if (typeSelect) {
              for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].value === question.question_type) {
                  typeSelect.selectedIndex = i
                  break
                }
              }

              // Disparar el evento change para mostrar/ocultar campos específicos
              const event = new Event("change")
              typeSelect.dispatchEvent(event)
            }

            // Mostrar campos específicos según el tipo
            const linearScaleFields = form.querySelector("#editLinearScaleFields")
            if (question.question_type === "linear_scale" && linearScaleFields) {
              linearScaleFields.classList.remove("d-none")

              // Establecer valores de escala
              const minValueField = form.querySelector("#edit_min_value")
              if (minValueField) minValueField.value = question.min_value || 1

              const maxValueField = form.querySelector("#edit_max_value")
              if (maxValueField) maxValueField.value = question.max_value || 5
            } else if (linearScaleFields) {
              linearScaleFields.classList.add("d-none")
            }

            // Configurar el botón de actualización
            const updateBtn = document.getElementById("updateQuestionBtn")
            if (updateBtn) {
              // Eliminar event listeners anteriores
              const newUpdateBtn = updateBtn.cloneNode(true)
              updateBtn.parentNode.replaceChild(newUpdateBtn, updateBtn)

              // Añadir nuevo event listener
              newUpdateBtn.addEventListener("click", () => {
                if (form.checkValidity()) {
                  // Enviar el formulario usando fetch para evitar recargar la página
                  const formData = new FormData(form)
                  const csrftoken = getCookie("csrftoken")

                  fetch(form.action, {
                    method: "POST",
                    headers: {
                      "X-CSRFToken": csrftoken,
                      "X-Requested-With": "XMLHttpRequest",
                    },
                    body: formData,
                  })
                    .then((response) => response.json())
                    .then((result) => {
                      // Cerrar el modal
                      const modal = bootstrap.Modal.getInstance(editModal)
                      if (modal) modal.hide()

                      if (result.success) {
                        showToast("{% trans_tag 'Question successfully updated' %}", "success")

                        // Recargar la página para mostrar los cambios
                        location.reload()
                      } else {
                        showToast(
                          "{% trans_tag 'Error updating question' %}: " + (result.error || "{% trans_tag 'Unknown error' %}"),
                          "danger"
                        )
                      }
                    })
                    .catch((error) => {
                      console.error("Error:", error)
                      showToast("{% trans_tag 'Error updating question' %}", "danger")
                    })
                } else {
                  form.reportValidity()
                }
              })
            }

            // Mostrar el modal
            if (bootstrap && bootstrap.Modal) {
              const modal = new bootstrap.Modal(editModal)
              modal.show()
            } else {
              // Fallback si bootstrap no está disponible
              editModal.style.display = "block"
            }
          } else {
            showToast("{% trans_tag 'Could not find the modal to edit the question' %}", "danger")
          }
        } else {
          showToast(
            "{% trans_tag 'Error loading question data' %}: " + (data.error || "{% trans_tag 'Unknown error' %}"),
            "danger"
          )
        }
      })
      .catch((error) => {
        console.error("Error:", error)
        showToast("{% trans_tag 'Error loading question data' %}", "danger")
      })
  }

  // Función para limpiar duplicados desde el servidor
  function cleanupDuplicatesFromServer() {
    // Crear un token CSRF
    const csrftoken = getCookie("csrftoken")

    // Mostrar indicador de carga
    const bankContainer = document.getElementById("questionBank")
    if (bankContainer) {
      bankContainer.innerHTML = '<div class="text-center p-3"><i class="bi bi-arrow-repeat spinner"></i> {% trans_tag "Cleaning duplicates..." %}</div>'
    }

    // Enviar solicitud para limpiar duplicados
    fetch("/forms/question-bank/clean/", {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrftoken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showToast(data.message || "{% trans_tag 'Duplicates successfully removed' %}", "success")
          
          // Recargar la página para mostrar los cambios
          location.reload()
        } else {
          showToast("{% trans_tag 'Error cleaning duplicates' %}: " + (data.error || "{% trans_tag 'Unknown error' %}"), "danger")
          
          // Recargar la página para mostrar el estado actual
          location.reload()
        }
      })
      .catch((error) => {
        console.error("Error:", error)
        showToast("{% trans_tag 'Error cleaning duplicates' %}", "danger")
        
        // Recargar la página para mostrar el estado actual
        location.reload()
      })
  }

  // Función para eliminar el backdrop de un modal
  function removeModalBackdrop() {
    const backdrop = document.querySelector(".modal-backdrop")
    if (backdrop) {
      backdrop.remove()
    }
  }

  // Inicializar botones para eliminar preguntas
  document.querySelectorAll(".delete-bank-question-btn").forEach((btn) => {
    btn.addEventListener("click", function() {
      const questionId = this.dataset.id
      
      // Configurar el modal de confirmación
      const deleteConfirmText = document.getElementById("deleteConfirmText")
      if (deleteConfirmText) {
        deleteConfirmText.textContent = "{% trans_tag 'Are you sure you want to delete this question from the bank?' %}"
      }
      
      // Configurar el botón de confirmación
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn")
      if (confirmDeleteBtn) {
        // Eliminar event listeners anteriores
        const newConfirmBtn = confirmDeleteBtn.cloneNode(true)
        confirmDeleteBtn.parentNode.replaceChild(newConfirmBtn, confirmDeleteBtn)
        
        // Añadir nuevo event listener
        newConfirmBtn.addEventListener("click", () => {
          // Cerrar el modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal"))
          if (modal) modal.hide()
          
          // Eliminar la pregunta
          deleteBankQuestion(questionId)
        })
      }
      
      // Mostrar el modal
      const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"))
      modal.show()
    })
  })

  // Inicializar botones para editar preguntas
  document.querySelectorAll(".edit-bank-question-btn").forEach((btn) => {
    btn.addEventListener("click", function() {
      const questionId = this.dataset.id
      editBankQuestion(questionId)
    })
  })

  // Inicializar botón para limpiar duplicados
  const cleanDuplicatesBtn = document.querySelector(".clean-duplicates-btn")
  if (cleanDuplicatesBtn) {
    cleanDuplicatesBtn.addEventListener("click", function() {
      cleanupDuplicatesFromServer()
    })
  }

  // Inicializar filtros
  const searchInput = document.getElementById("searchInput")
  const typeFilter = document.getElementById("typeFilter")
  const sortFilter = document.getElementById("sortFilter")

  function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase()
    const typeValue = typeFilter.value
    const sortValue = sortFilter.value
    
    const questions = document.querySelectorAll(".question-item")
    
    // Filtrar preguntas
    questions.forEach((question) => {
      const text = question.querySelector(".question-text").textContent.toLowerCase()
      const type = question.dataset.type
      
      const matchesSearch = text.includes(searchTerm)
      const matchesType = !typeValue || type === typeValue
      
      if (matchesSearch && matchesType) {
        question.style.display = ""
      } else {
        question.style.display = "none"
      }
    })
    
    // Ordenar preguntas
    const visibleQuestions = Array.from(questions).filter(q => q.style.display !== "none")
    
    if (sortValue === "alpha") {
      visibleQuestions.sort((a, b) => {
        const textA = a.querySelector(".question-text").textContent.toLowerCase()
        const textB = b.querySelector(".question-text").textContent.toLowerCase()
        return textA.localeCompare(textB)
      })
    } else if (sortValue === "usage") {
      visibleQuestions.sort((a, b) => {
        const usageA = parseInt(a.querySelector(".question-usage").textContent.match(/\d+/)[0])
        const usageB = parseInt(b.querySelector(".question-usage").textContent.match(/\d+/)[0])
        return usageB - usageA
      })
    }
    
    // Reordenar en el DOM
    const container = document.getElementById("questionBank")
    visibleQuestions.forEach(q => container.appendChild(q))
    
    // Mostrar mensaje si no hay resultados
    const noResults = visibleQuestions.length === 0
    let emptyMessage = container.querySelector(".empty-state")
    
    if (noResults && !emptyMessage) {
      emptyMessage = document.createElement("div")
      emptyMessage.className = "empty-state"
      emptyMessage.innerHTML = `
        <i class="bi bi-search"></i>
        <h3>{% trans_tag "No questions found" %}</h3>
        <p>{% trans_tag "Try changing your search criteria or filters." %}</p>
      `
      container.appendChild(emptyMessage)
    } else if (!noResults && emptyMessage) {
      emptyMessage.remove()
    }
  }

  if (searchInput) searchInput.addEventListener("input", applyFilters)
  if (typeFilter) typeFilter.addEventListener("change", applyFilters)
  if (sortFilter) sortFilter.addEventListener("change", applyFilters)

  // Inicializar el tipo de pregunta para mostrar/ocultar campos específicos
  const editQuestionType = document.getElementById("edit_question_type")
  const editLinearScaleFields = document.getElementById("editLinearScaleFields")

  if (editQuestionType) {
    editQuestionType.addEventListener("change", function() {
      if (this.value === "linear_scale") {
        editLinearScaleFields.classList.remove("d-none")
      } else {
        editLinearScaleFields.classList.add("d-none")
      }
    })
  }
  
  // Animación para las tarjetas
  const questionItems = document.querySelectorAll('.question-item');
  questionItems.forEach((item, index) => {
    item.style.opacity = '0';
    item.style.animation = `fadeIn 0.3s ease forwards ${index * 0.05}s`;
  });
})
</script>
{% endblock %}