{% extends 'base.html' %}
{% load form_tags %}
{% load static %}

{% block title %}Detalle de Respuesta{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/forms_google.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-5">
   <div class="d-flex justify-content-between align-items-center mb-4">
       <h1 class="fw-bold">Detalle de Respuesta</h1>
       <div class="d-flex gap-2">
           <a href="{% url 'gform_responses' form_id=gform.id %}" class="btn btn-outline-secondary">
               <i class="bi bi-arrow-left me-2"></i> Volver a Respuestas
           </a>
           <!-- Añadir botón para exportar a CSV -->
           <button class="btn btn-success" id="export-csv-btn">
               <i class="bi bi-file-earmark-excel me-2"></i> Exportar a CSV
           </button>
       </div>
   </div>

   <!-- Añadir modal para configurar la exportación -->
   <div class="modal fade" id="exportConfigModal" tabindex="-1" aria-labelledby="exportConfigModalLabel" aria-hidden="true">
     <div class="modal-dialog">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title" id="exportConfigModalLabel">Configurar Exportación</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body">
           <div class="row mb-3">
             <div class="col-md-6">
               <label for="startColumn" class="form-label">Columna de inicio</label>
               <input type="text" class="form-control" id="startColumn" maxlength="3" value="A">
               <div class="form-text">Letra de la columna donde comenzará la exportación (ej: A, B, C)</div>
             </div>
             <div class="col-md-6">
               <label for="startRow" class="form-label">Fila de inicio</label>
               <input type="number" class="form-control" id="startRow" min="1" value="1">
               <div class="form-text">Número de fila donde comenzará la exportación (ej: 15)</div>
             </div>
           </div>
           <div class="mb-3 form-check">
             <input type="checkbox" class="form-check-input" id="includeAttachments" checked>
             <label class="form-check-label" for="includeAttachments">Incluir archivos adjuntos</label>
           </div>
         </div>
         <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
           <button type="button" class="btn btn-primary" id="confirm-export">Exportar</button>
         </div>
       </div>
     </div>
   </div>

   <div class="response-card shadow-sm mb-4">
       <div class="response-header">
           <h3 class="mb-0">Información de la Respuesta</h3>
       </div>
       <div class="response-body">
           <div class="row">
               <div class="col-md-6">
                   <p><strong><i class="bi bi-file-earmark-text me-2"></i>Formulario:</strong> {{ gform.title }}</p>
                   <p><strong><i class="bi bi-person me-2"></i>Respondente:</strong>
                       {% if response.respondent %}
                       {{ response.respondent.username }}
                       {% elif response.respondent_email %}
                       {{ response.respondent_email }}
                       {% else %}
                       Anónimo
                       {% endif %}
                   </p>
               </div>
               <div class="col-md-6">
                   <p><strong><i class="bi bi-calendar3 me-2"></i>Fecha de respuesta:</strong> 
                       <span class="datetime" data-utc="{{ response.created_at|date:'c' }}">
                           {{ response.created_at|date:"d/m/Y H:i" }}
                       </span>
                   </p>
               </div>
           </div>
       </div>
   </div>

   <div class="response-card shadow-sm">
       <div class="response-header">
           <h3 class="mb-0">Respuestas</h3>
       </div>
       <div class="response-body">
           {% for question in questions %}
           <div class="response-item animate-fade-in">
               <div class="response-question">
                   <div class="d-flex align-items-start">
                       <span class="badge bg-primary me-2 mt-1">{{ forloop.counter }}</span>
                       <div>
                           {{ question.text }}
                           <div class="text-muted small">{{ question.get_question_type_display }}</div>
                       </div>
                   </div>
               </div>
               
               {% if question.image %}
               <div class="mb-3 mt-2">
                   <img src="{{ question.image.url }}" alt="Imagen de la pregunta" class="img-fluid rounded" style="max-height: 200px;">
               </div>
               {% endif %}
               
               {% if question.id in answer_dict %}
               {% with answer=answer_dict|get_item:question.id %}
               
               {% if question.question_type in 'short_text,paragraph,date,time,linear_scale' %}
               <div class="mt-3">
                   {% if answer.text_answer %}
                   <div class="response-answer">{{ answer.text_answer }}</div>
                   {% else %}
                   <p class="text-muted fst-italic">Sin respuesta</p>
                   {% endif %}
               </div>
               
               {% elif question.question_type in 'multiple_choice,dropdown,checkbox' %}
               <div class="mt-3">
                   {% if answer.selected_options.all %}
                   <ul class="list-group">
                       {% for selected in answer.selected_options.all %}
                       <li class="list-group-item d-flex align-items-center">
                           <i class="bi bi-check-circle-fill text-success me-2"></i>
                           {{ selected.option.text }}
                       </li>
                       {% endfor %}
                   </ul>
                   {% else %}
                   <p class="text-muted fst-italic">Sin respuesta</p>
                   {% endif %}
               </div>
               {% endif %}
               
               <!-- Mostrar archivos adjuntos -->
               {% if answer.image or answer.video or answer.file_url %}
               <div class="mt-3 p-3 bg-body-tertiary rounded">
                   <h6 class="mb-3"><i class="bi bi-paperclip me-2"></i>Archivos adjuntos:</h6>
                   
                   {% if answer.image %}
                   <div class="response-media mb-3">
                       <h6 class="text-muted small mb-2">Imagen:</h6>
                       <img src="{{ answer.image.url }}" alt="Imagen adjunta" class="img-fluid rounded">
                   </div>
                   {% endif %}
                   
                   {% if answer.video %}
                   <div class="response-media mb-3">
                       <h6 class="text-muted small mb-2">Video:</h6>
                       <video controls class="img-fluid rounded">
                           <source src="{{ answer.video.url }}" type="video/mp4">
                           Tu navegador no soporta la reproducción de videos.
                       </video>
                   </div>
                   {% endif %}
                   
                   {% if answer.file_url %}
                   <div class="response-media">
                       <h6 class="text-muted small mb-2">URL:</h6>
                       {% if answer.file_url|lower|endswith:'.jpg' or answer.file_url|lower|endswith:'.jpeg' or answer.file_url|lower|endswith:'.png' or answer.file_url|lower|endswith:'.gif' %}
                       <img src="{{ answer.file_url }}" alt="Imagen desde URL" class="img-fluid rounded">
                       {% elif answer.file_url|lower|endswith:'.mp4' or answer.file_url|lower|endswith:'.webm' or answer.file_url|lower|endswith:'.ogg' %}
                       <video controls class="img-fluid rounded">
                           <source src="{{ answer.file_url }}" type="video/mp4">
                           Tu navegador no soporta la reproducción de videos.
                       </video>
                       {% else %}
                       <a href="{{ answer.file_url }}" target="_blank" class="btn btn-outline-primary">
                           <i class="bi bi-link-45deg me-2"></i> Ver recurso externo
                       </a>
                       {% endif %}
                   </div>
                   {% endif %}
               </div>
               {% endif %}
               
               {% endwith %}
               {% else %}
               <p class="text-muted fst-italic mt-2">Sin respuesta</p>
               {% endif %}
           </div>
           {% endfor %}
       </div>
   </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/datetime-formatter.js' %}"></script>
<!-- Añadir script para exportar a CSV -->
<script>
   document.addEventListener('DOMContentLoaded', function() {
       // Abrir modal de configuración al hacer clic en el botón de exportar
       document.getElementById('export-csv-btn')?.addEventListener('click', function() {
           const modal = new bootstrap.Modal(document.getElementById('exportConfigModal'));
           modal.show();
       });
       
       // Función para validar la entrada de columna
       document.getElementById('startColumn')?.addEventListener('input', function() {
           // Convertir a mayúsculas y eliminar caracteres no alfabéticos
           const originalValue = this.value;
           const cleanValue = originalValue.toUpperCase().replace(/[^A-Z]/g, '');
           
           // Solo actualizar si hay cambios para evitar problemas con el cursor
           if (originalValue !== cleanValue) {
               this.value = cleanValue;
           }
           
           // Limitar a 3 caracteres (hasta la columna ZZZ)
           if (this.value.length > 3) {
               this.value = this.value.substring(0, 3);
           }
       });
       
       // Función para exportar a CSV con configuración personalizada
       document.getElementById('confirm-export')?.addEventListener('click', function() {
           const startColumnLetter = document.getElementById('startColumn').value.toUpperCase() || 'A';
           const startRow = parseInt(document.getElementById('startRow').value) || 1;
           const includeAttachments = document.getElementById('includeAttachments').checked;
           
           try {
               // Recopilar información básica de la respuesta
               const formTitle = "{{ gform.title|escapejs }}";
               const responseId = "{{ response.id|escapejs }}";
               const respondent = "{% if response.respondent %}{{ response.respondent.username|escapejs }}{% elif response.respondent_email %}{{ response.respondent_email|escapejs }}{% else %}Anónimo{% endif %}";
               const createdAt = document.querySelector('.datetime').textContent.trim();
               
               // Recopilar preguntas y respuestas directamente del DOM
               const responseItems = document.querySelectorAll('.response-item');
               const data = [];
               
               // Encabezados del CSV
               data.push(['Pregunta', 'Respuesta', includeAttachments ? 'Archivo adjunto' : '']);
               
               // Información de la respuesta
               data.push(['Formulario:', formTitle, '']);
               data.push(['Respuesta #:', responseId.toString(), '']);
               data.push(['Respondente:', respondent, '']);
               data.push(['Fecha:', createdAt, '']);
               data.push(['', '', '']); // Línea en blanco
               
               // Procesar cada pregunta y respuesta
               responseItems.forEach((item) => {
                   // Extraer la pregunta (sin el número)
                   const questionElement = item.querySelector('.response-question div div');
                   const questionText = questionElement.childNodes[0].textContent.trim();
                   
                   // Extraer la respuesta según su tipo
                   let answerText = 'Sin respuesta';
                   let attachmentUrl = '';
                   
                   // Buscar respuesta de texto
                   const responseAnswer = item.querySelector('.response-answer');
                   if (responseAnswer) {
                       answerText = responseAnswer.textContent.trim();
                   }
                   
                   // Buscar respuesta de selección múltiple
                   const listGroup = item.querySelector('.list-group');
                   if (listGroup) {
                       const options = Array.from(listGroup.querySelectorAll('.list-group-item'));
                       answerText = options.map(opt => {
                           // Eliminar el ícono de check
                           return opt.textContent.replace('✓', '').trim();
                       }).join(', ');
                   }
                   
                   // Buscar archivos adjuntos
                   if (includeAttachments) {
                       const mediaContainer = item.querySelector('.response-media');
                       if (mediaContainer) {
                           if (mediaContainer.querySelector('img')) {
                               attachmentUrl = mediaContainer.querySelector('img').src;
                           } else if (mediaContainer.querySelector('video source')) {
                               attachmentUrl = mediaContainer.querySelector('video source').src;
                           } else if (mediaContainer.querySelector('a')) {
                               attachmentUrl = mediaContainer.querySelector('a').href;
                           }
                       }
                   }
                   
                   // Añadir fila al CSV
                   data.push([questionText, answerText, attachmentUrl]);
               });
               
               // Convertir a CSV
               let csvContent = '';
               data.forEach(row => {
                   // Procesar cada celda para escapar comillas y caracteres especiales
                   const processedRow = row.map(cell => {
                       if (cell === null || cell === undefined) {
                           return '';
                       }
                       
                       const cellStr = String(cell);
                       // Si contiene comillas, comas o saltos de línea, encerrar en comillas y duplicar las comillas internas
                       if (cellStr.includes('"') || cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('\r')) {
                           return `"${cellStr.replace(/"/g, '""')}"`;
                       }
                       return cellStr;
                   });
                   
                   csvContent += processedRow.join(',') + '\r\n';
               });
               
               // Crear un enlace para descargar
               const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
               const link = document.createElement('a');
               link.setAttribute('href', encodedUri);
               link.setAttribute('download', `respuesta_${responseId}_${formTitle.replace(/\s+/g, '_')}.csv`);
               document.body.appendChild(link);
               
               // Descargar el archivo
               link.click();
               
               // Eliminar el enlace
               document.body.removeChild(link);
               
               // Cerrar el modal
               bootstrap.Modal.getInstance(document.getElementById('exportConfigModal')).hide();
               
           } catch (error) {
               console.error('Error al exportar:', error);
               alert('Error al exportar los datos. Por favor, inténtalo de nuevo.');
           }
       });
   });
</script>
{% endblock %}

